<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Azure &middot; Coding Journal</title>

    <meta name="description" content="Adventures in the world of C#, F# and WinRT">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Windows Azure &middot; Coding Journal">
    <meta name="twitter:description" content="Adventures in the world of C#, F# and WinRT">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Windows Azure &middot; Coding Journal">
    <meta property="og:description" content="Adventures in the world of C#, F# and WinRT">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://blog.kulman.sk/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Coding Journal" href="http://blog.kulman.sk/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://blog.kulman.sk">Coding Journal</a></h1>
            <h2 class="brand-tagline"> Adventures in the world of C#, F# and WinRT </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/igorkulman"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/igorkulman "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://blog.kulman.sk/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>

<div>
<h2>About me</h2>

<p>Igor Kulman is currently working as Windows Phone developer, also building applications for Microsoft Azure and playing with F#.</p>
<p>
Interested in programming languages, functional programming and data science.</p>

</div>

    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">15 Apr 2015, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/using-etag-to-cache-responses-in-nancyfx/" class="post-title">Using ETag to cache responses in NancyFX</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Caching data is usually a good idea, especially when creating APIs for mobile clients and the user may pay for each transferred byte. There are many approaches to caching data (I recommend reading <a href="http://frontendplay.com/2013/05/22/http-caching-demystified/">this article</a>), in my last NancyFX project I used ETag.</p>

<p><strong>ETag</strong></p>

<p>ETag is a HTTP header that acts as a hash of the data. When the server returns a response, it computes a hash of the data and sends it to the client. When the client requests the data again, it includes the ETag in its request. The server compares the ETag with the hash of the current data and if they match (the data did not change), it returns an empty responses with a HTTP 304 status code.</p>

<script src="https://gist.github.com/igorkulman/4e6d24d0fedfe8361c6b.js?file=etagresponse.cs"></script>

<p><strong>NancyFX impelemntation</strong></p>

<p>To implement caching using ETag in NancyFX I use a method in my base module</p>

<p>There are two parameters in this method, because you may sometimes want to compute the ETag from only a part of the returned model.</p>

<p>Using this method is the really simple</p>

<script src="https://gist.github.com/igorkulman/4e6d24d0fedfe8361c6b.js?file=usage.cs"></script>

                    </div>
                </section>
                
                <h1 class="content-subhead">12 Jan 2015, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/nancyfx-authentication-for-rest-api/" class="post-title">NancyFX authentication for REST API</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>NancyFX is a great .NET framework well suited for creating REST APIs. There are many ways how to approach authentication, the simplest one is the good old Forms Authentication. The idea of Forms Authentication is that the user logs in with a username and password and gets a cookie, the protected endpoints then check the cookie. NancyFX supports Forms Authentication with the <a href="https://www.nuget.org/packages/Nancy.Authentication.Forms/">Nancy.Authentication.Forms</a> package. The <a href="https://github.com/NancyFx/Nancy/wiki/Forms-Authentication">documentation describes how to use it on a web page</a>, but to use it with a REST API a few changes are needed.</p>

<p><strong>Forms Authentication differences for REST API</strong></p>

<p>There are things you want to do differently in a REST API than on a web page. If a user tries to access a protected endpoint, the Forms Authentication on a normal web page redirects him to the login page. In REST API, you typically want the endpoint just to return HTTP 401, no redirects. Also, when a user successfully logs in, you just typically want to return HTTP 200, no redirects.</p>

<p><strong>Disabling redirects</strong></p>

<p>Suppose you have Forms Authentication set up according to the documentation, with a IUserMapper and IUserIdentity implementation. Disabling the redirects is easy, just set a flag on the FormsAuthenticationConfiguration in your Bootstrapper:</p>

<script src="https://gist.github.com/igorkulman/2430a948fe6c426cdd01.js?file=Bootstrapper.cs"></script>

<p><strong>Changing Login and Logout methods</strong></p>

<p>The login implementation from the documentation uses the LoginAndRedirect method. There is also LoginWithoutRedirect method you want to use, but I found out it does not set the authentication cookie (when it does not think the request is an AJAX request), so the login basically does not work. A workaround I found is to call the LoginAndRedirect method, but only get the authentication cookie from the response ad return it manually:</p>

<script src="https://gist.github.com/igorkulman/2430a948fe6c426cdd01.js?file=login.cs"></script>

<p>The logout implementation just needs to call LogoutWithoutRedirect and return HTTP 200:</p>

<script src="https://gist.github.com/igorkulman/2430a948fe6c426cdd01.js?file=logout.cs"></script>

                    </div>
                </section>
                
                <h1 class="content-subhead">09 Jan 2014, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/c-scripting-console-for-asp-net-mvc-application/" class="post-title">C# scripting console for ASP.NET MVC application</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>In a recent larger ASP.NET MVC project running in Windows Azure I needed to provide the advanced users a way to execute custom scripts directly through the webbrowser. A kind of a scripting console where users can create and execute their own scripts, that interact with the project and automate some tasks (that would otherwise require too many clicks).</p>

<p><strong>Choosing the language</strong></p>

<p>I thought about using Lua but I needed an easy way to integrate with some classes (repositories) used in the project. I decided to use C# as the scripting language and implement the scripting console using <a href="http://msdn.microsoft.com/en-us/vstudio/roslyn.aspx">Roslyn</a>. Roslyn is a really neat project and I recommend taking a look at it, if you do not already know it.</p>

<p>I extracted the main idea of my implementation of the scripting console and <a href="http://igorkulman.github.io/WebConsole/">posted it on GitHub</a>. I will walk you through it in this blog post.</p>

<p><strong>Basic implementation</strong></p>

<p>My basic solution consists of a Textarea the user writes the script to, the script then gets executed by Roslyn and the final result is shown. I also included a basic Repository class to show, that the scripts can use classes from the project. In the real implementation I have a logger class showing the ongoing logs and results but as I said, the Github repo is just an extracted basic idea of the scripting console.</p>

<p>To execute a C# script in your ASP.NET MVC (or any other) application, you first need to install the Roslyn package and its dependencies</p>

<script src="https://gist.github.com/igorkulman/8159321.js?file=roslyn-nuget.ps"></script>

<p>Let&#8217;s suppose you have the C# script you want to execute in a string variable called command obtained from the mentioned Textarea. First, you need to create the scripting engine and a session</p>

<p>There are ScriptEngine classes, one for C# and one for VB.NET so choose the one for C#. You can use any class as the context for the scripts. In the sample, I have a ScriptingContext class containing one public property of a type DataRepository. If you use a class as the context for the scripts, you can access all its properties (Repository of type DataRepository in my case) in the scripts.</p>

<p>To use a class as the context for the scripts, just pass it to the Roslyn session</p>

<script src="https://gist.github.com/igorkulman/8159321.js?file=roslyn-session.cs"></script>

<p>If you want to use more than the core C# libraries, you need to do some referencing and importing. If you are using a class as the context for the scripts, you need to reference its assembly. Suppose you want to use classes and methods from System.Xml and System.Xml.Linq in your scripts. First, you need to add references to the session</p>

<script src="https://gist.github.com/igorkulman/8159321.js?file=roslyn-context.cs"></script>

<p>and then import them to the session</p>

<script src="https://gist.github.com/igorkulman/8159321.js?file=roslyn-import.cs"></script>

<p>Everything is set up now, so just execute the script and get the result</p>

<script src="https://gist.github.com/igorkulman/8159321.js?file=roslyn-exec.cs"></script>

<p>The result of the script is the result of the last expression of the script so I recommend using a logger class in the context if you want to get more information about the execution of your script.</p>

<p><strong>Conclusion</strong></p>

<p>Thanks to Roslyn, I was able to create a really usable scripting console for the project and allow users to automate many tasks using C# scripts. This article and the demo project describe just the basics, there are many ways to make the experience better. I for example use the <a href="http://codemirror.net/">CodeMirror</a> editor to provide C# syntax highlighting, to allow users to upload ZIP files they can process in their scripts, etc.</p>

<p>Source code: <a href="https://github.com/igorkulman/WebConsole">WebConsole</a></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">02 Oct 2013, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/returning-files-in-nancyfx/" class="post-title">Returning files in NancyFX</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>In my current project, I have chosen <a href="http://nancyfx.org/">NancyFx</a> to implement a REST API. NancyFx is a .NET framework known for its &#8220;<a href="https://github.com/NancyFx/Nancy/wiki/Introduction#the-super-duper-happy-path">super-duper-happy-path</a>&#8220;.</p>

<p>In one use case I generate a ZIP file in the temp folder and I want the API to return this ZIP file. NancyFx contains a Responses.AsFile helper but it works only with paths relative to the application.</p>

<p>If you have an absolute path of a file, you cannot use it. You need to create a StreamResponse and return the file as an attachment</p>

<p><script src="https://gist.github.com/6791265.js"></script></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">24 Jul 2013, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/intercepting-methods-with-ninject-for-error-logging/" class="post-title">Intercepting methods with Ninject for error logging</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>I am currently working on a fairly large Windows Azure projects that among other things conatins a Web Role where I use <a href="http://www.ninject.org/">Ninject</a> as a dependency container. As the business logic library grew larger I found myself writing a lot of repeating boiler plate code to log exceptions in many important methods. I wantet to remove all the boiler plate code and create a custom attribute, say LogErrorAttribute with one simple goal: each method decorated woth this attribute should log info about any occuring exception.</p>

<p><strong>IL weaving?</strong></p>

<p>I have been using <a href="https://github.com/Fody/Fody">Fody</a> for some time to <a href="http://blog.kulman.sk/inotifypropertychanged-the-easy-way-in-windows-phone-and-windows-8/" title="INotifyPropertyChanged the easy way in Windows Phone and Windows 8">implement the INotifyPropertyChanged calls for me in Windows Phone and Windows 8 projects</a> so it was my first choice.</p>

<p>There is a <a href="https://github.com/Fody/MethodDecorator">Fody.MethodDecorator</a> extensions that allows you to execute your code on a methods start, exit and exception. Writing the exception to Console is trivial, but I wanted to use a implementation of my custom ILogFactory.</p>

<p>There was no way to inject a ILogFactory implementation into the InterceptorAttribute. The only way that could work would be to use a ServiceLocator and I did not want to do it.</p>

<p><strong>Dynamic proxy!</strong></p>

<p>I came across <a href="http://www.castleproject.org/projects/dynamicproxy/">Castle Dynamic Proxy</a> and realized that there are Ninject extensions that allow you to easily use it.</p>

<p>First you need to install <a href="http://www.nuget.org/packages/Ninject.Extensions.Interception/3.0.0.8">Ninject.Extensions.Interception</a>. It has no depedencies other that Ninject, but you also have to install <a href="http://www.nuget.org/packages/Ninject.Extensions.Interception.DynamicProxy/3.0.0.8">Ninject.Extensions.Interception.DynamicProxy</a> (and <a href="http://www.nuget.org/packages/Castle.Core/">Castle.Core</a> as a dependency) otherwise it will not work.</p>

<p>First, create a class implementing the IInterceptor interface</p>

<p><script src="https://gist.github.com/6045777.js"></script></p>

<p>This class wraps the intercepted method invocation into a try..catch block and logs any occuring exception using my custom ILogFactory, including parameter values.</p>

<p>Next, create a class implementing the InterceptAttribute</p>

<p><script src="https://gist.github.com/6045812.js"></script></p>

<p>This attribute uses the Ninject kernel to get an instance of the ErrorLoggingInterceptor so you do not have to concern yourself explictily with providing an ILogFactory implementation, Ninject will do all the work.</p>

<p>Now you can use the LogErrorAttribute to mark any method, but keep in mind that all the marked methods must be virtual</p>

<p><script src="https://gist.github.com/6045825.js"></script></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">26 Feb 2013, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/f-on-azure-using-table-storage-for-logging/" class="post-title">F# on Azure: using Table Storage for logging</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Functional programming" href="http://blog.kulman.sk/categories/functional-programming">Functional programming</a><a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>Windows Azure finally has a good F# support. Creating F# Worker Roles is supported right from the wizzard in Visual Studio and you can create a F# Web Role using the <a href="http://visualstudiogallery.msdn.microsoft.com/3d2bf938-fc9e-403c-90b3-8de27dc23095">F# C# MVC template</a>. I decided to try it out and the first thing I needed to implement was logging. I decided for logging to Azure Table Storage.</p>

<p>I assume you have a basic idea of how Azure Table Storage works. If not, there is a <a href="http://www.windowsazure.com/en-us/develop/net/how-to-guides/table-services/">good guide on the Windows Azure website</a>.</p>

<p>The first thing you need to do is to define your log entry class. You need to create a class, Azure Table Storage does not work with F# records. In my case I want to store a timestamp, message and severity.</p>

<p><script src="https://gist.github.com/5822037.js"></script></p>

<p>Alternatively you can make your class inherit from TableEntity that already contains the PartitionKey and RowKey properties. The Severity property is in my case just a simple discriminated union</p>

<p><script src="https://gist.github.com/5822042.js"></script></p>

<p>You can access the Azure API in C# way but you do not need to, there is a great library called <a href="http://dmohl.github.com/Fog/">Fog by Dan Mohl</a> that makes using Azure API from F# more comfortable.</p>

<p>First you create a Azure Table Storage client using a connection string defined in the Windows Azure Cloud Service Configuration file for a role</p>

<p><script src="https://gist.github.com/5822066.js"></script></p>

<p>Saving a log entry is then very simple thanks to Fog</p>

<p><script src="https://gist.github.com/5822061.js"></script></p>

<p>Saving data to Azure Table Storage may be a slow operation if you do it a lot, so you may want to log asynchronously</p>

<p><script src="https://gist.github.com/5822056.js"></script></p>

<p>As you may have noticed, I use the date as the partiotion key. The thing with Azure Table Storage is, that you can get the data by partition key, row key, or all the data. The log date seems like a reasonable partition key that allows you to get log by days</p>

<p><script src="https://gist.github.com/5822053.js"></script></p>

<p><strong>Update:</strong> there is a more way to create the LogEntity using the CLIMuttableAttribte</p>

<p><script src="https://gist.github.com/5822050.js"></script></p>

                    </div>
                </section>
                
                <h1 class="content-subhead">08 Jan 2013, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/appharbor-great-place-to-start-your-net-project/" class="post-title">AppHarbor: great place to start your .NET project</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Programming in general" href="http://blog.kulman.sk/categories/programming-in-general">Programming in general</a><a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>If you want to host your .NET project on the Internet, there are classic ASP.NET webhosting on one side of the spectrum and Microsoft Azure on the other. If you are looking for something in the middle, take a look at <a href="https://appharbor.com/">AppHarbor</a>.</p>

<p><strong>AppHarbor</strong></p>

<p>AppHarbor is a flexible and scalable .NET Platform-as-a-Service, that you can even <a href="https://appharbor.com/pricing">use for free</a>, limited to one web or worker role. It runs in AWS and is quite similiar to Heroku.</p>

<p><strong>Variety of Add-ons</strong></p>

<p>There are <a href="https://appharbor.com/addons">many add-on supported by AppHarbor</a>, including SQL Server, MongoDB, RavenDB, MySQL, Memcacher &#8230; Many of these ad-ons offer free versions so you can test them for free. If you run into some problems, you can use <a href="http://support.appharbor.com/">the support forums</a> or <a href="http://stackoverflow.com/questions/tagged/appharbor">StackOverflow</a>.</p>

<p><strong>Flexible deployment</strong></p>

<p>The thing I like best about AppHarbor are the deployment options. You can push your .NET code to AppHarbor using Git, Mercurial, Subversion or Team Foundation Server with the complimentary Git service or through integrations offered in collaboration with <a href="http://support.appharbor.com/kb/api/integrating-with-bitbucket">Bitbucket</a>, <a href="http://support.appharbor.com/kb/api/integrating-with-codeplex">CodePlex</a> and <a href="http://blog.appharbor.com/2011/10/13/announcing-github-support">GitHub</a>.</p>

<p>When AppHarbor receives your code it will be built by a platform build server. If the code compiles, any unit tests contained in the compiled assemblies will be run. If the code builds and all tests execute successfully, the application is deployed to the AppHarbor application servers.</p>

<p><strong>Compatibility</strong></p>

<p>The majority of .NET code runs just fine in AppHarbor without any changes. If you use Nuget, you need to enabled Nuget Package Restore for your solution.</p>

<p>Let the continous deployment begin &#8230; my first AppHarbor project is hosted at <a href="http://myexpenses.apphb.com/">http://myexpenses.apphb.com</a>.</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">26 Oct 2012, 00:00</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.kulman.sk/updating-azure-toolkit-is-always-a-pain/" class="post-title">Updating Azure Toolkit is always a pain</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">Igor Kulman</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Windows Azure" href="http://blog.kulman.sk/categories/windows-azure">Windows Azure</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>From time to time I need to develop or maintain a small Windows Azure project. This time I wanted to create the whole project in F#. The first thing I needed to to was to update the Azure toolkit 1.8 (October 2012) but updating Azure Toolkit is always a pain. I started Web Platform Installer, selected Azure Toolkit 1.8, Azure Tools 1.8 for VS2012 and installed everything including the dependencies. What was the result? The whole Azure integration in Visual Studio 2012 stopped working. The Azure templates completely disappeared and Visual Studio only offered me downloading the Azure Toolkit, which failed, because it was already installed. I ended up completely uninstalling everything with the name containing Azure and installing the Azure toolkit again using the link from Visual Studio.</p>

<p>Why cannot this work better?</p>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://blog.kulman.sk/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-49528577-2', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
